document.addEventListener('DOMContentLoaded', function() {
    // ä¿ç•™ä½ åŸæœ‰çš„æ‰€æœ‰ JS ä»£ç 
    const body = document.body;
    const darkModeBtn = document.getElementById('darkModeBtn');
    const lightModeBtn = document.getElementById('lightModeBtn');
    
    function initMode() {
        const savedMode = localStorage.getItem('pageMode');
        if (savedMode === 'light') {
            enableLightMode();
        } else {
            enableDarkMode();
        }
    }

    function enableDarkMode() {
        body.classList.remove('light-mode');
        darkModeBtn.classList.add('active');
        lightModeBtn.classList.remove('active');
        localStorage.setItem('pageMode', 'dark');
    }

    function enableLightMode() {
        body.classList.add('light-mode');
        lightModeBtn.classList.add('active');
        darkModeBtn.classList.remove('active');
        localStorage.setItem('pageMode', 'light');
    }

    darkModeBtn.addEventListener('click', enableDarkMode);
    lightModeBtn.addEventListener('click', enableLightMode);
    initMode();

    const musicBtn = document.getElementById('musicBtn');
    const audio = new Audio('audio/1.mp3'); 
    let isMusicPlaying = false;

    musicBtn.addEventListener('click', function() {
        if (isMusicPlaying) {
            audio.pause();
            musicBtn.classList.remove('playing');
            isMusicPlaying = false;
        } else {
            audio.play().then(() => {
                musicBtn.classList.add('playing');
                isMusicPlaying = true;
            }).catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘è·¯å¾„æˆ–æµè§ˆå™¨æƒé™');
            });
        }
    });

    audio.addEventListener('ended', function() {
        musicBtn.classList.remove('playing');
        isMusicPlaying = false;
    });

    audio.addEventListener('error', function() {
        alert('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼šaudio/1.mp3');
    });

    let lastX = 0, lastY = 0;
    const particleCount = 8;
    const fireworkCount = 15;
    const particleInterval = 15;
    window.lastParticleTime = 0;

    function createTrailParticle(x, y) {
        const dx = x - lastX;
        const dy = y - lastY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < 0.5) return;

        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 6 + 3;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${x - size/2}px`;
        particle.style.top = `${y - size/2}px`;

        const tx = (Math.random() - 0.5) * 15 - dx * 1.5;
        const ty = (Math.random() - 0.5) * 15 - dy * 1.5;
        particle.style.setProperty('--tx', `${tx}px`);
        particle.style.setProperty('--ty', `${ty}px`);
        particle.style.animation = `trail 0.8s ease-out forwards`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 800);

        lastX = x;
        lastY = y;
    }

    function createFireworkParticle(x, y) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 6 + 4;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${x - size/2}px`;
        particle.style.top = `${y - size/2}px`;

        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * 80 + 30;
        const fx = Math.cos(angle) * distance;
        const fy = Math.sin(angle) * distance;
        particle.style.setProperty('--fx', `${fx}px`);
        particle.style.setProperty('--fy', `${fy}px`);
        particle.style.animation = `firework 1.2s ease-out forwards`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1200);
    }

    document.addEventListener('mousemove', (e) => {
        const now = Date.now();
        if (now - window.lastParticleTime < particleInterval) return;
        window.lastParticleTime = now;
        for (let i = 0; i < particleCount; i++) {
            setTimeout(() => createTrailParticle(e.clientX, e.clientY), i * 10);
        }
    });

    document.addEventListener('click', (e) => {
        for (let i = 0; i < fireworkCount; i++) {
            setTimeout(() => createFireworkParticle(e.clientX, e.clientY), i * 20);
        }
    });

    const announcement = document.getElementById('announcement');
    const announcementClose = document.getElementById('announcementClose');
    localStorage.removeItem('announcementClosed');
    
    announcementClose.addEventListener('click', () => {
        announcement.classList.add('hidden');
        setTimeout(() => announcement.style.display = 'none', 300);
    });

    const carousel = document.getElementById('carousel');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const indicators = document.querySelectorAll('.indicator');
    const carouselItems = document.querySelectorAll('.carousel-item');
    let currentIndex = 0;
    const totalItems = carouselItems.length;

    function updateSlideActiveState() {
        carouselItems.forEach((item, i) => item.classList.toggle('active-slide', i === currentIndex));
    }

    function goToSlide(index) {
        index = index < 0 ? totalItems - 1 : index >= totalItems ? 0 : index;
        carousel.style.transform = `translateX(-${index * 100}%)`;
        indicators.forEach((ind, i) => ind.classList.toggle('active', i === index));
        currentIndex = index;
        updateSlideActiveState();
    }

    updateSlideActiveState();
    let autoPlay = setInterval(() => goToSlide(currentIndex + 1), 5000);

    prevBtn.addEventListener('click', () => { clearInterval(autoPlay); goToSlide(currentIndex - 1); autoPlay = setInterval(() => goToSlide(currentIndex + 1), 5000); });
    nextBtn.addEventListener('click', () => { clearInterval(autoPlay); goToSlide(currentIndex + 1); autoPlay = setInterval(() => goToSlide(currentIndex + 1), 5000); });
    indicators.forEach(ind => ind.addEventListener('click', () => { clearInterval(autoPlay); goToSlide(parseInt(ind.dataset.index)); autoPlay = setInterval(() => goToSlide(currentIndex + 1), 5000); }));

    // ä¿®å¤ï¼šé‡æ–°è·å–æ‰€æœ‰å¡ç‰‡ï¼ˆç¡®ä¿åŒ…å«æ˜¥æ™šå¡ç‰‡ï¼‰ï¼Œå¹¶ç»‘å®šç‚¹å‡»äº‹ä»¶
    const photoCards = document.querySelectorAll('.photo-card, .spring-festival-card');
    const initialImage = document.getElementById('initialImage');
    const videoIframe = document.getElementById('videoIframe');

    // ä¿®å¤ï¼šç¡®ä¿æ¯ä¸ªå¡ç‰‡éƒ½æ­£ç¡®ç»‘å®šç‚¹å‡»äº‹ä»¶
    photoCards.forEach(card => {
        card.addEventListener('click', function() {
            try {
                // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„activeçŠ¶æ€
                document.querySelectorAll('.photo-card').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.spring-festival-card').forEach(c => c.classList.remove('active'));
                // ç»™å½“å‰ç‚¹å‡»çš„å¡ç‰‡æ·»åŠ activeçŠ¶æ€
                this.classList.add('active');
                
                // é‡ç½®è§†é¢‘å®¹å™¨çŠ¶æ€
                initialImage.style.opacity = '1';
                initialImage.style.display = 'block';
                videoIframe.classList.remove('loaded');
                
                // è·å–è§†é¢‘é“¾æ¥å¹¶ä¼˜åŒ–Bç«™æ’­æ”¾å‚æ•°
                let videoUrl = this.dataset.video;
                // æ·»åŠ å¿…è¦çš„Bç«™æ’­æ”¾å‚æ•°
                if (videoUrl.includes('bilibili.com')) {
                    // ç§»é™¤autoplay=1ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰ï¼Œæ·»åŠ å…¶ä»–å¿…è¦å‚æ•°
                    videoUrl = videoUrl.replace('autoplay=1', '') + '&high_quality=1&danmaku=0&allowfullscreen=true';
                }
                
                // å»¶è¿ŸåŠ è½½iframeé¿å…é—ªçƒ
                setTimeout(() => {
                    initialImage.style.opacity = '0';
                    // å…ˆæ¸…ç©ºåŸæœ‰srcï¼Œé¿å…ç¼“å­˜é—®é¢˜
                    videoIframe.src = '';
                    // è®¾ç½®æ–°çš„è§†é¢‘é“¾æ¥
                    videoIframe.src = videoUrl;
                    videoIframe.classList.add('loaded');
                    // ç¡®ä¿å°é¢å›¾éšè—
                    setTimeout(() => {
                        initialImage.style.display = 'none';
                    }, 500);
                }, 300);
                
                // è°ƒè¯•ï¼šæ‰“å°è§†é¢‘é“¾æ¥ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
                console.log('æ’­æ”¾è§†é¢‘ï¼š', videoUrl);
            } catch (error) {
                console.error('è§†é¢‘åŠ è½½å¤±è´¥:', error);
                alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });
    });

    // éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘
    const audioTracks = [
        { title: "éŸ³ä¹1 - æœ€è¿‘æ¯”è¾ƒçƒ¦", artist: "äº”å“¥", src: "audio/1.mp3" },
        { title: "éŸ³ä¹2 - é¬¼è¿·äº†å¿ƒçª", artist: "äº”å“¥", src: "audio/2.mp3" },
        { title: "éŸ³ä¹3 - å½“ä½ å­¤å•ä½ ä¼šæƒ³èµ·è°", artist: "äº”å“¥", src: "audio/3.mp3" }
    ];

    const playerAudio = new Audio();
    let currentTrackIndex = 0;
    let isPlaying = false;
    let volume = 0.7;

    const audioPlaylist = document.getElementById('audioPlaylist');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevTrackBtn = document.getElementById('prevTrackBtn');
    const nextTrackBtn = document.getElementById('nextTrackBtn');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const progressHandle = document.getElementById('progressHandle');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeFill = document.getElementById('volumeFill');
    const volumeIcon = document.getElementById('volumeIcon');

    playerAudio.volume = volume;
    // ä¿®å¤1ï¼šæ·»åŠ ç¼ºå¤±çš„åˆ†å·
    volumeFill.style.width = `${volume * 100}%`;
    
    // åˆå§‹åŒ–æ’­æ”¾åˆ—è¡¨
    function initPlaylist() {
        audioTracks.forEach((track, index) => {
            const trackEl = document.createElement('div');
            trackEl.className = `audio-track ${index === currentTrackIndex ? 'active' : ''}`;
            trackEl.dataset.index = index;
            trackEl.innerHTML = `
                <div class="audio-track-title">${track.title}</div>
                <div class="audio-track-artist">${track.artist}</div>
            `;
            trackEl.addEventListener('click', () => {
                currentTrackIndex = index;
                loadTrack();
                playTrack();
            });
            audioPlaylist.appendChild(trackEl);
        });
    }

    // åŠ è½½éŸ³é¢‘è½¨é“
    function loadTrack() {
        playerAudio.src = audioTracks[currentTrackIndex].src;
        // æ›´æ–°æ’­æ”¾åˆ—è¡¨æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.audio-track').forEach((el, index) => {
            el.classList.toggle('active', index === currentTrackIndex);
        });
        // éŸ³é¢‘åŠ è½½å®Œæˆåæ›´æ–°æ€»æ—¶é•¿
        playerAudio.addEventListener('loadedmetadata', updateTotalTime);
    }

    // æ’­æ”¾éŸ³é¢‘
    function playTrack() {
        playerAudio.play().then(() => {
            isPlaying = true;
            playPauseBtn.textContent = 'â¸';
        }).catch(error => {
            console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
            alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®åé‡è¯•ï¼ˆæµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰');
        });
    }

    // æš‚åœéŸ³é¢‘
    function pauseTrack() {
        playerAudio.pause();
        isPlaying = false;
        playPauseBtn.textContent = 'â–¶';
    }

    // ä¸Šä¸€æ›²
    function prevTrack() {
        currentTrackIndex = (currentTrackIndex - 1 + audioTracks.length) % audioTracks.length;
        loadTrack();
        if (isPlaying) playTrack();
    }

    // ä¸‹ä¸€æ›²
    function nextTrack() {
        currentTrackIndex = (currentTrackIndex + 1) % audioTracks.length;
        loadTrack();
        if (isPlaying) playTrack();
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // æ›´æ–°å½“å‰æ—¶é—´
    function updateCurrentTime() {
        currentTimeEl.textContent = formatTime(playerAudio.currentTime);
        const progress = (playerAudio.currentTime / playerAudio.duration) * 100;
        progressFill.style.width = `${progress}%`;
        progressHandle.style.left = `${progress}%`;
    }

    // æ›´æ–°æ€»æ—¶é•¿
    function updateTotalTime() {
        totalTimeEl.textContent = formatTime(playerAudio.duration);
    }

    // è¿›åº¦æ¡ç‚¹å‡»äº‹ä»¶
    progressBar.addEventListener('click', (e) => {
        const progress = (e.offsetX / progressBar.offsetWidth) * 100;
        progressFill.style.width = `${progress}%`;
        progressHandle.style.left = `${progress}%`;
        playerAudio.currentTime = (progress / 100) * playerAudio.duration;
    });

    // éŸ³é‡è°ƒèŠ‚
    volumeSlider.addEventListener('click', (e) => {
        volume = e.offsetX / volumeSlider.offsetWidth;
        volume = Math.max(0, Math.min(1, volume));
        playerAudio.volume = volume;
        volumeFill.style.width = `${volume * 100}%`;
        
        // æ›´æ–°éŸ³é‡å›¾æ ‡
        if (volume === 0) {
            volumeIcon.textContent = 'ğŸ”‡';
        } else if (volume < 0.5) {
            volumeIcon.textContent = 'ğŸ”‰';
        } else {
            volumeIcon.textContent = 'ğŸ”Š';
        }
    });

    // æ’­æ”¾æš‚åœæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    playPauseBtn.addEventListener('click', () => {
        if (isPlaying) {
            pauseTrack();
        } else {
            // å¦‚æœè¿˜æ²¡åŠ è½½éŸ³é¢‘ï¼Œå…ˆåŠ è½½
            if (!playerAudio.src) {
                loadTrack();
            }
            playTrack();
        }
    });

    // ä¸Šä¸€æ›²/ä¸‹ä¸€æ›²æŒ‰é’®äº‹ä»¶
    prevTrackBtn.addEventListener('click', prevTrack);
    nextTrackBtn.addEventListener('click', nextTrack);

    // éŸ³é¢‘æ—¶é—´æ›´æ–°äº‹ä»¶
    playerAudio.addEventListener('timeupdate', updateCurrentTime);

    // éŸ³é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
    playerAudio.addEventListener('ended', nextTrack);

    // åˆå§‹åŒ–æ’­æ”¾åˆ—è¡¨
    initPlaylist();

    // è¿”å›é¡¶éƒ¨æŒ‰é’®
    const backToTop = document.getElementById('backToTop');
    backToTop.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ä½œè€…å¼¹çª—
    const authorBtn = document.getElementById('authorBtn');
    const authorModal = document.getElementById('authorModal');
    const modalClose = document.getElementById('modalClose');

    authorBtn.addEventListener('click', () => {
        authorModal.classList.add('active');
    });

    modalClose.addEventListener('click', () => {
        authorModal.classList.remove('active');
    });

    // ç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸå…³é—­
    authorModal.addEventListener('click', (e) => {
        if (e.target === authorModal) {
            authorModal.classList.remove('active');
        }
    });
});